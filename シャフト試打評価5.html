<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>ã‚´ãƒ«ãƒ•ã‚¯ãƒ©ãƒ–è©•ä¾¡ã‚·ãƒ¼ãƒˆï¼ˆã‚¹ãƒãƒ›å¯¾å¿œï¼‰</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body { font-family: system-ui, sans-serif; margin: 8px; background:#f2f2f2; }
h1 { font-size:20px; text-align:center; margin-bottom:12px; }

button { font-size:16px; padding:8px 12px; margin:4px; border-radius:4px; cursor:pointer; }
.card { background:#fff; border-radius:8px; padding:10px; margin-bottom:12px; box-shadow:0 1px 3px rgba(0,0,0,.1); }

.table-wrapper { overflow-x:auto; }
table { width:100%; border-collapse: collapse; table-layout: fixed; }
th, td { border:1px solid #ccc; padding:6px; font-size:14px; vertical-align: middle; }
th { background:#eee; }
th:first-child, td:first-child { font-size:16px; font-weight:bold; }
.meaning { font-size:16px; color:#444; white-space: normal; word-break: break-word; max-width:160px; vertical-align: middle; }

.header { display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; }
.topbox { background:#fafafa; border:1px solid #ddd; border-radius:6px; padding:8px; margin-bottom:8px; }

.input-with-voice { display:flex; align-items:center; gap:4px; margin-top:4px; }
.input-with-voice button { flex:0 0 auto; font-size:16px; padding:6px 10px; height:36px; border-radius:4px; }
.input-with-voice input[type="text"], .input-with-voice input[type="number"] { flex:1; font-size:16px; padding:6px; box-sizing:border-box; }

/* æŠ˜ã‚ŠãŸãŸã¿ç”¨ */
.sample-content { transition: max-height 0.3s ease, padding 0.3s ease, margin 0.3s ease; overflow: hidden; max-height: 2000px; }
.sample-content.collapsed { max-height:0; padding:0; margin:0; }

@media (max-width:600px){
  th, td{ font-size:13px; padding:4px; }
  button{ font-size:14px; padding:6px 8px; margin:2px; }
  .meaning{ max-width:120px; font-size:14px; }
  .input-with-voice input[type="text"], .input-with-voice input[type="number"]{ font-size:14px; padding:4px; }
}
</style>
</head>
<body>

<h1>ã‚´ãƒ«ãƒ•ã‚¯ãƒ©ãƒ–è©•ä¾¡ï¼ˆCSVå‡ºåŠ›å¯¾å¿œï¼‰</h1>

<div class="topbox">
  è©•ä¾¡è€…åï¼ˆå¿…é ˆï¼‰
  <div class="input-with-voice">
    <button onclick="voiceInput('evaluator')">ğŸ¤</button>
    <input type="text" id="evaluator" placeholder="ä¾‹ï¼šã‚ªãƒãƒ• æ¬¡éƒ" oninput="saveData()">
  </div>
</div>

<div class="topbox">
  <strong>ã‚·ãƒ¼ãƒˆä½œæˆè€…ç”¨</strong><br>
  <button onclick="setEditMode()">ğŸ”“ ç·¨é›†ãƒ¢ãƒ¼ãƒ‰</button>
  <button onclick="setEvalMode()">ğŸ”’ è©•ä¾¡ãƒ¢ãƒ¼ãƒ‰ï¼ˆãƒ­ãƒƒã‚¯ï¼‰</button>
</div>

<button onclick="addSample()">ï¼‹ ã‚µãƒ³ãƒ—ãƒ«è¿½åŠ </button>
<button onclick="exportCSV()">ğŸ“„ CSVå‡ºåŠ›</button>
<button onclick="clearData()">ğŸ—‘ ãƒ‡ãƒ¼ã‚¿å‰Šé™¤</button>

<div id="samples"></div>

<script>
// --- æ—¢å­˜è¨­å®š ---
const STORAGE_KEY = "golf_eval_v2";
const MODE_KEY = "golf_eval_mode";
function setEditMode(){ localStorage.setItem(MODE_KEY, "edit"); applyMode(); }
function setEvalMode(){ if(!confirm("ã‚µãƒ³ãƒ—ãƒ«åã‚’ãƒ­ãƒƒã‚¯ã—ã¦è©•ä¾¡ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆã¾ã™ã‹ï¼Ÿ")) return; localStorage.setItem(MODE_KEY, "eval"); applyMode(); }
function getMode(){ return localStorage.getItem(MODE_KEY) || "edit"; }
function applyMode(){
  const isEval = getMode() === "eval";
  document.querySelectorAll(`[id$="_name"]`).forEach(inp=>{ inp.disabled = isEval; });
  document.querySelectorAll("button").forEach(btn=>{
    const txt = btn.textContent;
    if(txt.includes("ã‚µãƒ³ãƒ—ãƒ«è¿½åŠ ") || txt.includes("ã‚µãƒ³ãƒ—ãƒ«å‰Šé™¤") || txt.includes("ãƒ‡ãƒ¼ã‚¿å‰Šé™¤")){
      btn.style.display = isEval ? "none" : "";
    }
  });
}

const items = [
 {key:"dist", label:"é£›è·é›¢", meaning:"1:é£›ã°ãªã„ / 5:ã‚ˆãé£›ã¶"},
 {key:"easy", label:"æ‰“ã¡ã‚„ã™ã•", meaning:"1:é›£ã—ã„ / 5:éå¸¸ã«æ˜“ã—ã„"},
 {key:"up", label:"ä¸Šã‚Šæ˜“ã•", meaning:"1:ä¸ŠãŒã‚‰ãªã„ / 5:éå¸¸ã«ä¸ŠãŒã‚‹"},
 {key:"launch", label:"æ‰“ã¡å‡ºã—(é«˜ä½)", meaning:"1:ä½ã„ / 5:é«˜ã„"},
 {key:"traj", label:"å¼¾é“ï¼ˆæ˜‡é™è»Œé“ï¼‰", meaning:"1:å¹ã‘ã‚‹ / 5:å¼·ã„"},
 {key:"dir", label:"æ–¹å‘æ€§", meaning:"1:æ‚ªã„ / 5:éå¸¸ã«è‰¯ã„"},
 {key:"dir_launch_ref", label:"æ‰“ã¡å‡ºã—ï¼ˆå·¦å³ï¼‰", meaning:"5:å·¦ / 4:ã‚„ã‚„å·¦ / 3:ä¸­ / 2:ã‚„ã‚„å³ / 1:å³"},
 {key:"dir_traj_ref", label:"å¼¾é“ï¼ˆã‚µã‚¤ãƒ‰ï¼‰", meaning:"5:ãƒ•ãƒƒã‚¯ / 4:å¼±ãƒ•ãƒƒã‚¯ / 3:ã‚¹ãƒˆãƒ¬ãƒ¼ãƒˆ / 2:å¼±ã‚¹ãƒ©ã‚¤ã‚¹ / 1:ã‚¹ãƒ©ã‚¤ã‚¹"},
 {key:"meet", label:"ãƒŸãƒ¼ãƒˆç‡", meaning:"1:æ‚ªã„ / 5:è‰¯ã„"},
 {key:"swing", label:"æŒ¯ã‚Šã‚„ã™ã•", meaning:"1:æŒ¯ã‚Šã«ãã„ / 5:æŒ¯ã‚Šã‚„ã™ã„"},
 {key:"flex", label:"ãƒ•ãƒ¬ãƒƒã‚¯ã‚¹", meaning:"1:æŸ”ã‚‰ã‹ã„ / 5:ç¡¬ã„"},
 {key:"balance", label:"ãƒãƒ©ãƒ³ã‚¹", meaning:"1:è»½ã„ / 5:é‡ã„"},
 {key:"grip", label:"ã‚°ãƒªãƒƒãƒ—å¾„", meaning:"1:ç´°ã„ / 5:å¤ªã„"},
 {key:"rank", label:"é †ä½", meaning:"æ•°å­—ãŒå¤§ãã„ã»ã©é †ä½ãŒæ‚ªã„"},
 {key:"comment", label:"ãƒ•ãƒªãƒ¼ã‚³ãƒ¡ãƒ³ãƒˆ", meaning:"è‡ªç”±è¨˜è¿°"}
];

let sampleCount = 0;

// æŠ˜ã‚ŠãŸãŸã¿ãƒˆã‚°ãƒ«
function toggleSample(btn){
  const content = btn.closest(".card").querySelector(".sample-content");
  const collapsed = content.classList.toggle("collapsed");
  btn.textContent = collapsed ? "â–¶" : "â–¼";
}

// ã‚µãƒ³ãƒ—ãƒ«è¿½åŠ 
function addSample(data=null){
  sampleCount++;
  const index = sampleCount;
  const wrap = document.createElement("div");
  wrap.className = "card";
  wrap.dataset.index = index;
  const sampleName = data?.name ?? "";

  wrap.innerHTML = `
    <div class="header">
      <strong>ã‚µãƒ³ãƒ—ãƒ« ${index}</strong>
      <button onclick="toggleSample(this)">â–¼</button>
    </div>

    <div class="sample-content">
      <div class="topbox">
        ã‚µãƒ³ãƒ—ãƒ«åï¼ˆå¿…é ˆï¼‰
        <div class="input-with-voice">
          <button onclick="voiceInput('s${index}_name')">ğŸ¤</button>
          <input type="text" id="s${index}_name" placeholder="ä¾‹ï¼š24AKA 10.5 TATAKI50" value="${sampleName}" oninput="saveData()">
        </div>
      </div>

      <div class="table-wrapper">
        <table>
          <tr><th>é …ç›®</th><th>å…¥åŠ›</th><th>ç›®å®‰</th></tr>
${items.map(i=>{
  const id = `s${index}_${i.key}`;
  const value = data?.[i.key] ?? "";
  const isRank = i.key === "rank";
  const isComment = i.key === "comment";
  return `<tr>
    <td>${i.label}</td>
    <td>
      <div class="input-with-voice">
        <button onclick="voiceInput('${id}')">ğŸ¤</button>
        ${
          isComment
          ? `<input type="text" id="${id}" value="${value}" placeholder="ä¾‹ï¼šæ•ã¾ã‚ŠãŒè‰¯ãå©ã‘ã‚‹å°è±¡" oninput="saveData()">`
          : `<input type="number" id="${id}" min="1" ${isRank ? 'step="1" inputmode="numeric"' : 'max="5" step="0.1" inputmode="decimal"'} value="${value}" oninput="saveData()">`
        }
      </div>
    </td>
    <td class="meaning">${i.meaning}</td>
  </tr>`;
}).join("")}
        </table>
      </div>
      <button onclick="removeSample(this)">ã‚µãƒ³ãƒ—ãƒ«å‰Šé™¤</button>
    </div>
  `;
  document.getElementById("samples").appendChild(wrap);
  saveData();
}

function removeSample(btn){ btn.closest(".card").remove(); saveData(); }

// éŸ³å£°å…¥åŠ›
function voiceInput(id){
  if(!('webkitSpeechRecognition' in window)){ alert("ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯éŸ³å£°å…¥åŠ›ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“"); return; }
  const rec = new webkitSpeechRecognition();
  rec.lang = "ja-JP"; rec.start();
  rec.onresult = e => {
    let text = e.results[0][0].transcript.trim();
    const el = document.getElementById(id);
    const numMap = {"ã‚¼ãƒ­":"0","ã‚Œã„":"0","é›¶":"0","zero":"0","ã„ã¡":"1","ä¸€":"1","one":"1","ãƒ¯ãƒ³":"1","ã«":"2","äºŒ":"2","two":"2","ãƒ„ãƒ¼":"2","ã•ã‚“":"3","ä¸‰":"3","three":"3","ã‚¹ãƒªãƒ¼":"3","ã‚ˆã‚“":"4","å››":"4","ã—":"4","four":"4","ãƒ•ã‚©ãƒ¼":"4","ã”":"5","äº”":"5","five":"5","ãƒ•ã‚¡ã‚¤ãƒ–":"5"};
    const alphaMap = {"ã‚¨ãƒ¼":"A","ã‚¨ã‚¤":"A","ãƒ“ãƒ¼":"B","ã‚·ãƒ¼":"C","ãƒ‡ã‚£ãƒ¼":"D","ã‚¤ãƒ¼":"E","ã‚¨ãƒ•":"F","ã‚¸ãƒ¼":"G","ã‚¨ã‚¤ãƒ":"H","ã‚¢ã‚¤":"I","ã‚¸ã‚§ãƒ¼":"J","ã‚±ãƒ¼":"K","ã‚¨ãƒ«":"L","ã‚¨ãƒ ":"M","ã‚¨ãƒŒ":"N","ã‚ªãƒ¼":"O","ãƒ”ãƒ¼":"P","ã‚­ãƒ¥ãƒ¼":"Q","ã‚¢ãƒ¼ãƒ«":"R","ã‚¨ã‚¹":"S","ãƒ†ã‚£ãƒ¼":"T","ãƒ¦ãƒ¼":"U","ãƒ–ã‚¤":"V","ãƒ€ãƒ–ãƒªãƒ¥ãƒ¼":"W","ã‚¨ãƒƒã‚¯ã‚¹":"X","ãƒ¯ã‚¤":"Y","ã‚ºã‚£ãƒ¼":"Z","ã‚¼ãƒƒãƒˆ":"Z"};
    Object.keys(numMap).forEach(k=>{ text=text.replace(new RegExp(k,"gi"),numMap[k]); });
    Object.keys(alphaMap).forEach(k=>{ text=text.replace(new RegExp(k,"g"),alphaMap[k]); });
    if(el.type==="number"){ el.value=text.replace(/[^\d]/g,''); } else { el.value=text; }
    saveData();
  };
}

// ä¿å­˜ãƒ»å¾©å…ƒãƒ»CSVãƒ»å…¨å‰Šé™¤
function saveData(){
  const data={evaluator:document.getElementById("evaluator").value,samples:[]};
  document.querySelectorAll(".card").forEach(card=>{
    const obj={name: card.querySelector(`[id$="_name"]`).value};
    items.forEach(i=>{ obj[i.key]=card.querySelector(`[id$='_${i.key}']`).value; });
    data.samples.push(obj);
  });
  localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
}

function loadData(){
  const raw = localStorage.getItem(STORAGE_KEY);
  if(!raw){ addSample(); return; }
  const data = JSON.parse(raw);
  document.getElementById("evaluator").value = data.evaluator || "";
  if(data.samples.length===0){ addSample(); } else { data.samples.forEach(d=>addSample(d)); }
  applyMode();
}

function exportCSV(){
  const evaluator=document.getElementById("evaluator").value.trim();
  if(!evaluator){ alert("è©•ä¾¡è€…åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚"); return; }
  const rows=[];
  const header=["è©•ä¾¡è€…å","æ—¥æ™‚","ã‚µãƒ³ãƒ—ãƒ«ç•ªå·","ã‚µãƒ³ãƒ—ãƒ«å",...items.map(i=>i.label)];
  rows.push(header);
  const now = new Date().toLocaleString();
  document.querySelectorAll(".card").forEach((card,idx)=>{
    const row=[evaluator,now,idx+1,card.querySelector(`[id$="_name"]`).value];
    items.forEach(i=>{ row.push(card.querySelector(`[id$='_${i.key}']`).value); });
    rows.push(row);
  });
  const csvBody=rows.map(r=>`"${r.join('","')}"`).join("\n");
  const csv="\uFEFF"+csvBody;
  const blob=new Blob([csv], {type:"text/csv;charset=utf-8;"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a");
  const ts=new Date().toISOString().replace(/[:.]/g,"-");
  a.href=url;
  a.download=`golf_eval_${evaluator}_${ts}.csv`;
  a.click();
  URL.revokeObjectURL(url);
}

function clearData(){ if(confirm("ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã‚’ã™ã¹ã¦å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")){ localStorage.removeItem(STORAGE_KEY); location.reload(); } }

loadData();
</script>

</body>
</html>

